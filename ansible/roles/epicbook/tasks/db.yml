
---
# Wait for MySQL to be ready
- name: Wait for MySQL to be ready
  wait_for:
    host: "{{ mysql_host }}"
    port: "{{ mysql_port }}"
    timeout: 300
    delay: 10

# Install sequelize-cli globally
- name: Install sequelize-cli globally
  npm:
    name: sequelize-cli
    global: yes
    state: present

# Download Azure MySQL CA certificate
- name: Download Azure MySQL CA certificate
  get_url:
    url: https://dl.cacerts.digicert.com/BaltimoreCyberTrustRoot.crt.pem
    dest: /etc/mysql/ca.pem
    mode: '0644'
    validate_certs: no

# Create /root/.my.cnf for safe login
- name: Ensure /root/.my.cnf exists
  copy:
    dest: /root/.my.cnf
    content: |
      [client]
      user={{ mysql_username }}
      password={{ mysql_password }}
      host={{ mysql_host }}
    owner: root
    group: root
    mode: '0600'

# Ensure the database exists
- name: Ensure MySQL database exists
  community.mysql.mysql_db:
    name: "bookstore"
    state: present
    login_user: "mysqladmin@epicbook-mysql-dev"
    login_password: "@xlaBT!V#oZF8pHl"
    login_host: epicbook-mysql.mysql.database.azure.com
    login_port: 3306
    client_cert: /etc/mysql/client-cert.pem
    client_key: /etc/mysql/client-key.pem
    ca_cert: /etc/mysql/ca.pem

# Import SQL files
- name: Import SQL files
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/BuyTheBook_Schema.sql
  args:
    executable: /bin/bash

- name: Import author seed
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/author_seed.sql
  args:
    executable: /bin/bash

- name: Import books seed
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/books_seed.sql
  args:
    executable: /bin/bash

# Run migrations if migrations folder exists
- name: Check migrations folder
  stat:
    path: "{{ app_dir }}/migrations"
  register: migrations_dir

- name: Run migrations
  command: npx sequelize-cli db:migrate
  args:
    chdir: "{{ app_dir }}"
  when: migrations_dir.stat.exists

# Run seeders if seeders folder exists
- name: Check seeders folder
  stat:
    path: "{{ app_dir }}/seeders"
  register: seeders_dir

- name: Run seeds
  command: npx sequelize-cli db:seed:all
  args:
    chdir: "{{ app_dir }}"
  when: seeders_dir.stat.exists
