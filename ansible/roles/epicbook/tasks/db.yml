---
# Wait for MySQL to be ready
- name: Wait for MySQL to be ready
  wait_for:
    host: "{{ mysql_host }}"
    port: "{{ mysql_port }}"
    timeout: 300
    delay: 10

# Install sequelize-cli globally
- name: Install sequelize-cli globally
  npm:
    name: sequelize-cli
    global: yes
    state: present

# Create or ensure the database exists (no SSL)
- name: Ensure MySQL database exists
  community.mysql.mysql_db:
    name: "{{ mysql_database }}"
    state: present
    login_host: "{{ mysql_host }}"
    login_port: "{{ mysql_port }}"
    login_user: "{{ mysql_username }}"
    login_password: "{{ mysql_password }}"

# Import schema and seed data (with CREATE TABLE IF NOT EXISTS)
- name: Import BuyTheBook schema
  shell: |
    mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} << 'EOSQL'
    CREATE TABLE IF NOT EXISTS author (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        bio TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS books (
        id INT AUTO_INCREMENT PRIMARY KEY,
        title VARCHAR(255) NOT NULL,
        author_id INT NOT NULL,
        published_date DATE,
        price DECIMAL(10,2),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (author_id) REFERENCES author(id)
    );
    EOSQL
  args:
    executable: /bin/bash

- name: Import author seed
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/author_seed.sql
  args:
    executable: /bin/bash

- name: Import books seed
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/books_seed.sql
  args:
    executable: /bin/bash

# Run migrations if migrations folder exists
- name: Check migrations folder
  stat:
    path: "{{ app_dir }}/migrations"
  register: migrations_dir

- name: Run migrations
  command: npx sequelize-cli db:migrate
  args:
    chdir: "{{ app_dir }}"
  when: migrations_dir.stat.exists

# Run seeders if seeders folder exists
- name: Check seeders folder
  stat:
    path: "{{ app_dir }}/seeders"
  register: seeders_dir

- name: Run seeds
  command: npx sequelize-cli db:seed:all
  args:
    chdir: "{{ app_dir }}"
  when: seeders_dir.stat.exists
