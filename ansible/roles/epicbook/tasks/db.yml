
---
# Wait for MySQL to be ready
- name: Wait for MySQL to be ready
  wait_for:
    host: "{{ mysql_host }}"
    port: "{{ mysql_port }}"
    timeout: 300
    delay: 10

# Install sequelize-cli globally
- name: Install sequelize-cli globally
  npm:
    name: sequelize-cli
    global: yes
    state: present

# Ensure SSL Certificate Exists
- name: Ensure /etc/ssl/certs exists
  file:
    path: /etc/ssl/certs
    state: directory
    owner: root
    group: root
    mode: '0755'

# Copy SSL certificate to Azure MySQL Server
- name: Copy Azure MySQL certificate to server
  copy:
    src: files/BaltimoreCyberTrustRoot.crt.pem
    dest: /etc/ssl/certs/BaltimoreCyberTrustRoot.crt.pem
    owner: root
    group: root
    mode: '0644'

# Create or ensure the database exists
- name: Ensure MySQL database exists
  community.mysql.mysql_db:
    name: "{{ mysql_database }}"
    state: present
    login_host: "{{ mysql_host }}"
    login_port: "{{ mysql_port }}"
    login_user: "{{ mysql_username }}"
    login_password: "{{ mysql_password }}"
    ssl_disabled: yes

# Import schema and data
- name: Import SQL files
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/BuyTheBook_Schema.sql
  args:
    executable: /bin/bash

- name: Import author seed
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/author_seed.sql
  args:
    executable: /bin/bash

- name: Import books seed
  shell: mysql -h {{ mysql_host }} -u {{ mysql_username }} -p{{ mysql_password }} {{ mysql_database }} < {{ app_dir }}/db/books_seed.sql
  args:
    executable: /bin/bash

# Run migrations if migrations folder exists
- name: Check migrations folder
  stat:
    path: "{{ app_dir }}/migrations"
  register: migrations_dir

- name: Run migrations
  command: npx sequelize-cli db:migrate
  args:
    chdir: "{{ app_dir }}"
  when: migrations_dir.stat.exists

# Run seeders if seeders folder exists
- name: Check seeders folder
  stat:
    path: "{{ app_dir }}/seeders"
  register: seeders_dir

- name: Run seeds
  command: npx sequelize-cli db:seed:all
  args:
    chdir: "{{ app_dir }}"
  when: seeders_dir.stat.exists
